'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _url = require('url');

var _url2 = _interopRequireDefault(_url);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function json(replacer, space) {
  var callback = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 'callback';

  var stringify = replacer || space ? function (val) {
    return JSON.stringify(val, replacer, space);
  } : function (val) {
    return JSON.stringify(val);
  };

  return function (req, res, next) {
    res.json = function (val) {
      var body = stringify(val);
      if (!res.getHeader('content-type')) {
        res.setHeader('Content-Type', 'application/json; charset=utf-8');
      }

      res.end(body, 'utf8');
    };

    res.jsonp = function (val) {
      var reqUrl = _url2.default.parse(req.url, true);
      if (reqUrl.query[callback]) {
        var cb = reqUrl.query[callback];
        var body = stringify(val);
        if (!res.getHeader('content-type')) {
          res.setHeader('Content-Type', 'text/javascript; charset=utf-8');
        }

        res.end('typeof ' + cb + ' === \'function\' && ' + cb + '(' + body + ');', 'utf8');
      } else {
        res.json(val); // No callback query string? Fallback to json
      }
    };

    next();
  };
}

exports.default = json;

module.exports = json;